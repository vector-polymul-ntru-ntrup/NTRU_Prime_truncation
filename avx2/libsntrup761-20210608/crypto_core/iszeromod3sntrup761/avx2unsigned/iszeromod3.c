#include "crypto_core.h"

#include "params.h"

#include "const_inline.h"
#include "mult3_karatsuba.h"

#include "string.h"


#define ALIGNED __attribute((aligned(32)))

static const
ALIGNED unsigned char fac0[32] = { 2, 2, 0, 2,  2, 2, 1, 2,  1, 2, 0, 2,  1, 1, 1, 1,  2, 0, 1, 1 ,  0, 0, 0, 0,  0, 0, 0, 0,  0, 0, 0, 0 };

static const
ALIGNED unsigned char invfac0[768] = {
0, 0, 0, 0,  0, 0, 0, 1,  0, 0, 2, 0,  2, 0, 0, 0,   2, 0, 0, 1,  0, 1, 0, 2,  2, 1, 2, 2,  2, 0, 0, 0,
1, 1, 2, 0,  2, 1, 0, 0,  2, 0, 2, 1,  2, 0, 0, 0,   1, 1, 1, 1,  2, 0, 0, 2,  0, 0, 2, 2,  0, 2, 0, 2,
1, 0, 0, 1,  0, 2, 2, 2,  2, 2, 2, 2,  1, 0, 1, 2,   1, 0, 2, 0,  0, 2, 1, 1,  1, 2, 0, 2,  0, 2, 0, 1,
2, 2, 0, 2,  0, 1, 1, 1,  2, 2, 2, 2,  2, 1, 2, 2,   0, 2, 2, 2,  0, 0, 2, 2,  1, 1, 2, 2,  2, 1, 1, 0,
1, 2, 2, 1,  1, 0, 0, 1,  2, 0, 0, 1,  1, 2, 2, 0,   1, 2, 0, 1,  2, 0, 2, 2,  1, 0, 1, 1,  1, 2, 2, 2,
2, 2, 0, 2, 0, 2, 1, 2, 0, 0, 0, 0, 1, 1, 0, 1, 2, 1, 2, 2, 1, 1, 0, 0, 1, 1, 1, 2, 2, 2, 2, 0,
2, 2, 2, 0, 2, 0, 2, 0, 1, 0, 2, 1, 0, 1, 1, 1, 2, 2, 0, 0, 2, 1, 0, 1, 1, 1, 1, 0, 0, 2, 0, 2,
2, 1, 0, 1, 0, 2, 0, 2, 0, 1, 0, 2, 2, 2, 1, 2, 1, 1, 1, 0, 2, 1, 0, 2, 2, 0, 0, 2, 2, 1, 1, 1,
2, 0, 0, 2, 0, 1, 2, 0, 0, 0, 1, 0, 2, 1, 0, 1, 1, 1, 2, 0, 1, 0, 0, 1, 1, 2, 0, 1, 0, 1, 0, 0,
0, 1, 1, 1, 1, 1, 2, 0, 1, 0, 1, 2, 0, 2, 2, 1, 1, 2, 2, 0, 2, 0, 2, 0, 1, 2, 0, 2, 1, 0, 2, 1,
1, 2, 2, 1, 2, 1, 0, 1, 1, 0, 1, 2, 2, 2, 0, 2, 0, 0, 0, 1, 0, 2, 0, 2, 2, 2, 1, 0, 0, 2, 1, 0,
1, 0, 2, 1, 1, 1, 1, 1, 0, 0, 2, 1, 2, 1, 2, 1, 1, 1, 0, 1, 2, 2, 0, 1, 2, 1, 0, 2, 0, 2, 0, 1,
2, 1, 2, 0, 1, 0, 1, 1, 1, 1, 2, 0, 1, 2, 1, 1, 1, 1, 2, 2, 2, 2, 0, 0, 0, 1, 1, 2, 1, 2, 1, 2,
0, 1, 2, 1, 2, 2, 1, 0, 2, 0, 2, 2, 1, 0, 0, 1, 1, 1, 2, 1, 1, 0, 0, 0, 2, 2, 1, 2, 2, 0, 1, 1,
0, 2, 0, 0, 0, 2, 1, 1, 2, 2, 0, 1, 0, 2, 1, 1, 2, 0, 2, 1, 0, 2, 1, 0, 2, 0, 1, 2, 2, 0, 2, 2,
2, 2, 0, 1, 2, 1, 2, 0, 0, 0, 1, 1, 1, 0, 0, 1, 2, 1, 0, 1, 1, 0, 0, 2, 2, 2, 1, 0, 2, 0, 2, 0,
1, 2, 0, 0, 0, 2, 2, 2, 1, 0, 2, 2, 0, 2, 2, 1, 0, 1, 0, 1, 1, 0, 1, 2, 2, 0, 2, 0, 0, 2, 1, 1,
0, 2, 1, 2, 2, 1, 2, 1, 0, 1, 1, 2, 1, 1, 2, 1, 0, 2, 2, 2, 2, 1, 2, 1, 0, 2, 2, 1, 0, 2, 0, 0,
0, 2, 0, 1, 1, 2, 2, 2, 1, 0, 0, 0, 1, 2, 2, 0, 0, 0, 1, 2, 1, 1, 2, 2, 0, 2, 1, 2, 0, 2, 2, 2,
1, 0, 0, 2, 2, 0, 1, 2, 2, 1, 1, 2, 1, 0, 1, 2, 2, 0, 2, 1, 0, 0, 2, 2, 0, 0, 2, 2, 0, 1, 2, 1,
1, 0, 2, 0, 0, 2, 1, 0, 2, 2, 1, 0, 2, 2, 0, 2, 0, 1, 2, 0, 2, 1, 2, 2, 1, 0, 1, 1, 0, 0, 2, 1,
1, 0, 0, 0, 0, 0, 2, 0, 1, 0, 2, 0, 0, 1, 1, 0, 0, 2, 2, 1, 0, 0, 2, 2, 2, 1, 1, 1, 0, 1, 0, 0,
2, 2, 1, 1, 2, 0, 1, 1, 2, 1, 2, 2, 2, 1, 1, 0, 2, 0, 0, 1, 1, 0, 1, 0, 2, 2, 1, 2, 0, 2, 0, 1,
1, 0, 2, 0, 0, 2, 1, 2, 0, 1, 0, 1, 2, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 };


static const
ALIGNED unsigned char fac1[64] = {
1, 2, 1, 1, 0, 0, 1, 2, 0, 2, 0, 2, 0, 1, 1, 1, 1, 1, 0, 0, 2, 0, 1, 1, 0, 0, 1, 0, 1, 0, 0, 2,
2, 1, 1, 2, 0, 1, 1, 0, 0, 1, 1, 2, 0, 0, 1, 1, 1, 1, 2, 0, 0, 1, 2, 0, 2, 2, 1, 0, 1, 0, 0, 0 };


static const
ALIGNED unsigned char invfac1[768] = {
0, 0, 0, 0, 0, 0, 0, 2, 1, 2, 2, 2, 1, 1, 2, 2, 1, 1, 0, 1, 1, 0, 0, 1, 2, 1, 2, 1, 2, 1, 2, 0,
1, 2, 0, 2, 2, 1, 2, 1, 1, 0, 0, 2, 1, 2, 1, 1, 1, 2, 2, 1, 2, 1, 0, 2, 2, 1, 1, 2, 0, 1, 2, 2,
0, 0, 0, 2, 1, 1, 0, 2, 2, 1, 2, 0, 0, 0, 0, 1, 2, 2, 0, 1, 1, 0, 0, 1, 2, 2, 1, 0, 0, 1, 0, 2,
1, 1, 2, 2, 0, 1, 1, 1, 1, 2, 2, 1, 1, 1, 0, 2, 1, 1, 1, 2, 0, 1, 1, 1, 2, 1, 0, 1, 2, 2, 1, 0,
0, 0, 0, 0, 0, 0, 0, 2, 1, 1, 2, 2, 1, 0, 0, 0, 1, 2, 1, 0, 0, 2, 2, 1, 1, 2, 1, 0, 1, 2, 0, 1,
2, 1, 2, 2, 1, 2, 2, 2, 2, 1, 0, 2, 0, 2, 2, 2, 2, 1, 0, 0, 2, 0, 2, 1, 1, 0, 0, 1, 0, 0, 0, 1,
0, 0, 1, 2, 2, 2, 0, 1, 0, 0, 0, 0, 2, 1, 0, 2, 0, 0, 1, 1, 2, 0, 1, 0, 2, 0, 1, 1, 0, 0, 2, 0,
2, 2, 2, 2, 2, 0, 1, 0, 2, 1, 0, 0, 1, 2, 0, 2, 2, 1, 2, 2, 1, 0, 2, 2, 2, 2, 2, 0, 1, 2, 0, 2,
0, 1, 2, 1, 1, 2, 1, 0, 1, 1, 2, 2, 1, 1, 0, 0, 0, 2, 2, 0, 1, 1, 0, 1, 1, 1, 1, 2, 1, 0, 0, 1,
0, 2, 0, 1, 0, 2, 0, 1, 1, 1, 2, 0, 2, 2, 0, 0, 1, 2, 0, 2, 0, 0, 1, 2, 0, 1, 2, 0, 1, 2, 1, 1,
1, 2, 1, 2, 1, 2, 0, 1, 1, 0, 1, 1, 1, 2, 0, 1, 1, 0, 1, 2, 2, 1, 0, 1, 1, 2, 2, 1, 1, 0, 1, 1,
1, 2, 1, 2, 2, 1, 2, 2, 1, 1, 2, 0, 0, 1, 2, 2, 1, 1, 2, 1, 2, 0, 2, 0, 0, 2, 1, 2, 1, 1, 2, 2,
0, 0, 2, 1, 1, 2, 1, 2, 1, 0, 2, 2, 2, 2, 1, 0, 0, 1, 0, 2, 2, 1, 2, 2, 1, 1, 2, 0, 1, 2, 1, 2,
0, 0, 2, 0, 1, 0, 0, 0, 1, 2, 2, 2, 2, 1, 0, 2, 2, 2, 1, 2, 2, 2, 0, 0, 1, 1, 0, 1, 1, 1, 2, 0,
1, 1, 1, 1, 0, 1, 1, 2, 1, 0, 1, 1, 0, 2, 1, 1, 0, 1, 1, 1, 2, 1, 1, 0, 0, 2, 2, 0, 2, 1, 1, 1,
1, 1, 1, 0, 0, 2, 0, 2, 1, 1, 1, 0, 0, 2, 1, 0, 1, 1, 2, 0, 0, 2, 1, 2, 0, 0, 2, 0, 2, 1, 0, 1,
1, 2, 0, 1, 1, 0, 2, 1, 1, 1, 2, 1, 2, 2, 1, 2, 0, 0, 2, 1, 0, 1, 2, 1, 2, 0, 0, 0, 2, 2, 0, 2,
0, 0, 1, 2, 1, 1, 1, 0, 2, 1, 1, 0, 1, 2, 0, 1, 2, 2, 2, 1, 0, 1, 1, 2, 1, 2, 2, 1, 0, 1, 2, 2,
1, 0, 1, 0, 2, 1, 0, 2, 1, 2, 1, 2, 2, 2, 2, 1, 0, 2, 1, 2, 1, 0, 0, 2, 1, 1, 1, 2, 2, 0, 0, 1,
2, 1, 2, 0, 0, 2, 1, 2, 2, 0, 2, 0, 1, 0, 2, 2, 2, 0, 1, 1, 0, 0, 2, 0, 1, 1, 2, 0, 1, 0, 1, 0,
0, 1, 0, 2, 2, 2, 1, 2, 2, 0, 0, 0, 2, 0, 2, 0, 0, 0, 2, 0, 2, 1, 1, 2, 0, 1, 1, 1, 2, 2, 0, 0,
2, 1, 0, 2, 0, 2, 2, 2, 1, 0, 0, 0, 1, 2, 2, 1, 0, 1, 0, 2, 1, 0, 2, 2, 1, 1, 2, 1, 0, 1, 2, 1,
2, 1, 2, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 };


static const
ALIGNED unsigned char fac2[768] = {
1, 1, 0, 0, 2, 1, 1, 1, 0, 1, 2, 0, 2, 1, 0, 0, 0, 1, 1, 1, 2, 2, 1, 0, 1, 0, 1, 1, 0, 2, 1, 0,
2, 0, 2, 1, 0, 0, 2, 1, 0, 1, 2, 2, 2, 2, 2, 2, 0, 1, 1, 1, 1, 2, 2, 2, 0, 1, 1, 0, 1, 0, 0, 0,
1, 2, 0, 2, 2, 1, 0, 2, 1, 2, 2, 0, 2, 0, 2, 1, 2, 0, 1, 0, 0, 1, 2, 1, 1, 0, 0, 0, 1, 1, 0, 0,
0, 2, 0, 0, 0, 1, 1, 1, 2, 2, 2, 0, 0, 2, 0, 1, 2, 2, 1, 2, 1, 1, 0, 2, 2, 1, 2, 0, 0, 1, 2, 1,
2, 1, 2, 0, 1, 1, 2, 1, 0, 0, 0, 2, 1, 0, 0, 1, 1, 0, 0, 0, 0, 2, 0, 2, 1, 0, 1, 1, 2, 0, 1, 1,
0, 0, 1, 2, 2, 1, 0, 0, 1, 0, 1, 2, 0, 1, 1, 1, 2, 0, 1, 0, 1, 2, 2, 1, 2, 2, 1, 2, 1, 0, 2, 1,
1, 1, 0, 2, 1, 1, 0, 1, 0, 0, 2, 0, 1, 1, 0, 0, 0, 0, 1, 2, 2, 0, 2, 2, 1, 2, 0, 0, 0, 2, 0, 0,
1, 2, 2, 2, 1, 2, 2, 0, 1, 0, 2, 1, 1, 2, 2, 0, 0, 0, 2, 2, 0, 2, 1, 2, 2, 1, 1, 2, 0, 2, 0, 0,
2, 2, 0, 0, 1, 0, 2, 0, 2, 2, 0, 0, 0, 0, 1, 2, 0, 1, 1, 0, 2, 2, 1, 0, 1, 2, 2, 2, 2, 1, 0, 1,
0, 0, 0, 1, 2, 0, 2, 2, 0, 2, 2, 1, 0, 1, 1, 1, 0, 1, 1, 0, 0, 0, 1, 0, 1, 2, 0, 0, 2, 0, 1, 2,
1, 0, 1, 2, 2, 2, 1, 1, 2, 1, 1, 2, 1, 2, 2, 1, 0, 0, 0, 0, 1, 0, 2, 0, 1, 0, 2, 0, 0, 2, 0, 0,
1, 1, 2, 0, 1, 1, 2, 0, 2, 0, 2, 1, 2, 2, 2, 1, 2, 2, 0, 0, 1, 2, 1, 0, 1, 2, 0, 0, 1, 0, 2, 2,
0, 0, 2, 1, 1, 2, 2, 1, 0, 1, 0, 2, 2, 0, 0, 1, 1, 1, 1, 0, 2, 1, 1, 2, 2, 2, 0, 1, 1, 1, 1, 0,
0, 0, 0, 1, 1, 0, 1, 1, 1, 2, 2, 0, 1, 1, 0, 0, 2, 2, 2, 1, 0, 0, 2, 0, 2, 1, 0, 0, 1, 0, 2, 2,
0, 0, 2, 1, 0, 2, 1, 0, 1, 1, 2, 1, 1, 2, 1, 1, 0, 0, 2, 1, 2, 0, 0, 0, 2, 2, 0, 0, 0, 1, 0, 0,
2, 0, 1, 2, 1, 1, 2, 0, 1, 1, 1, 1, 2, 2, 2, 2, 0, 0, 2, 1, 1, 0, 0, 0, 2, 0, 2, 0, 0, 2, 2, 2,
1, 1, 2, 1, 0, 2, 0, 1, 1, 1, 1, 0, 1, 0, 1, 1, 2, 1, 1, 2, 2, 0, 1, 2, 0, 1, 1, 0, 0, 1, 1, 0,
2, 2, 0, 2, 2, 2, 1, 2, 2, 2, 1, 1, 1, 0, 1, 1, 1, 0, 2, 2, 1, 1, 1, 1, 1, 0, 0, 1, 1, 2, 2, 2,
2, 2, 0, 0, 0, 1, 1, 2, 1, 1, 0, 1, 1, 2, 1, 0, 1, 0, 2, 1, 1, 1, 1, 0, 1, 0, 1, 1, 2, 0, 0, 2,
0, 0, 0, 2, 1, 1, 0, 0, 0, 0, 2, 0, 1, 1, 2, 0, 2, 0, 2, 2, 1, 0, 1, 1, 0, 1, 2, 0, 2, 1, 1, 2,
2, 0, 2, 2, 1, 1, 1, 1, 2, 1, 1, 1, 1, 0, 2, 2, 2, 2, 2, 1, 2, 2, 2, 1, 1, 1, 1, 2, 2, 2, 2, 0,
0, 1, 0, 2, 1, 0, 1, 2, 0, 2, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 };

static const
ALIGNED unsigned char invfac2[128] = {
0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 2, 2, 2, 2, 0, 1, 2, 0, 2, 0, 2, 1, 0, 2, 1, 2, 0, 1, 0, 1, 0,
0, 0, 0, 0, 1, 0, 2, 2, 0, 2, 0, 1, 0, 0, 1, 0, 1, 2, 2, 1, 0, 0, 0, 0, 0, 0, 2, 2, 1, 2, 1, 1,
2, 2, 0, 0, 1, 0, 2, 2, 0, 0, 1, 1, 2, 0, 2, 2, 2, 2, 2, 2, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0,
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 };


////////////////////////////////////////

static
__m256i mult3_deg768_invfac0( const unsigned char* poly )
{
  __m256i r = _mm256_setzero_si256();
  __m256i r0[2];

  mult3_32x32( (unsigned char *)r0 , poly, invfac0+768-32 );
  r = add_r3(r,r0[1]);
  for(int i=32;i<768;i+=32){
    mult3_32x32( (unsigned char *)r0 , poly+i , invfac0+768-i);
    r = add_r3(r,r0[0]);
    mult3_32x32( (unsigned char *)r0, poly+i , invfac0+768-32-i );
    r = add_r3(r,r0[1]);
  }
  return r;
}


static
void mod3_fac0( unsigned char *rem , const unsigned char* poly )
{
  __m256i r0[2];
  __m256i deg768 = mult3_deg768_invfac0(poly);
  mult3_32x32( (unsigned char *)r0 , (const unsigned char *)&deg768 , fac0 );
  __m256i r = add_r3( _mm256_load_si256((const __m256i*) poly) , reduce_neg(r0[0]) );

  _mm256_store_si256( (__m256i*)rem , r );
}


static
unsigned char is_multiple_of_fac0( const unsigned char *poly )
{
  __m256i r;
  mod3_fac0( (unsigned char *)&r , poly );

  unsigned a = _mm256_movemask_epi8( _mm256_cmpeq_epi8(r,_mm256_setzero_si256()) ); // 0->0xffffffff
  unsigned long long aa = a;
  aa += 1;
  aa >>= 32;
  return (aa&1);
}

////////////////////////////////////////

static
void mult3_deg768_invfac1( unsigned char * quo, const unsigned char* poly )
{
  __m256i r[2];
  __m256i r0[4];

  mult3_64x64( (unsigned char *)r0 , poly, invfac1+768-64 );
  r[0] = r0[2];
  r[1] = r0[3];
  for(int i=64;i<768;i+=64){
    mult3_64x64( (unsigned char *)r0 , poly+i , invfac1+768-i);
    r[0] = add_r3(r[0],r0[0]);
    r[1] = add_r3(r[1],r0[1]);
    mult3_64x64( (unsigned char *)r0, poly+i , invfac1+768-64-i );
    r[0] = add_r3(r[0],r0[2]);
    r[1] = add_r3(r[1],r0[3]);
  }
  _mm256_store_si256( (__m256i*)quo , r[0]);
  _mm256_store_si256( (__m256i*)(quo+32) , r[1]);
}


static
void mod3_fac1( unsigned char *rem, const unsigned char* poly )
{
  __m256i r0[2];
  __m256i r1[4];
  mult3_deg768_invfac1( (unsigned char*) r0, poly);
  mult3_64x64( (unsigned char *)r1 , (const unsigned char *)r0 , fac1 );
  for(int i=0;i<64;i+=32) {
    __m256i a = _mm256_load_si256((const __m256i*) &poly[i]);
    __m256i b = add_r3( a , reduce_neg(r1[i>>5]) );
    _mm256_store_si256( (__m256i*)&rem[i] , b );
  }
}


static
unsigned char is_multiple_of_fac1( const unsigned char *poly )
{
  __m256i r0[2];
  mod3_fac1( (unsigned char *)r0 , poly );

  __m256i r = r0[0]|r0[1];
  unsigned a = _mm256_movemask_epi8( _mm256_cmpeq_epi8(r,_mm256_setzero_si256()) ); // 0->0xffffffff
  unsigned long long aa = a;
  aa += 1;
  aa >>= 32;
  return (aa&1);
}

////////////////////////////////////


static
void mult3_deg768_invfac2( unsigned char * r, const unsigned char* poly )
{
  ALIGNED unsigned char r0[256];

  mult3_128x128( r0 , poly+640, invfac2 );

  for(int i=0;i<128;i++) {
    r[i] = r0[128+i];
  }
}


static
void mod3_fac2( unsigned char * r , const unsigned char* poly )
{
  ALIGNED unsigned char r0[128];
  ALIGNED unsigned char r1[256];
  ALIGNED unsigned char r2[768+128];

  mult3_deg768_invfac2( r0 , poly);

  mult3_128x128( r2 , r0 , fac2 );

  for(int i=128;i<768;i+=128) {
    mult3_128x128( r1 , r0 , fac2 + i );
    for(int j=0;j<128;j+=32) {
      __m256i r2j = _mm256_load_si256((const __m256i*)(r2+i+j));
      __m256i r1j = _mm256_load_si256((const __m256i*)(r1+j));
      __m256i rr = add_r3( r2j , r1j );
      _mm256_store_si256( (__m256i*)(r2+i+j) , rr );
    }
    memcpy( r2+i+128 , r1+128 , 128 );
  }

  for(int i=0;i<682;i+=32) {
      __m256i a = _mm256_load_si256((const __m256i*)(poly+i));
      __m256i b = _mm256_load_si256((const __m256i*)(r2+i));
      __m256i c = add_r3(a,reduce_neg(b));
      _mm256_store_si256( (__m256i*)(r+i) , c );
  }
}

static
unsigned char is_multiple_of_fac2( const unsigned char *poly )
{
  __m256i r0[22];
  mod3_fac2( (unsigned char *)r0 , poly );

  __m256i r = r0[0];
  for(int i=1;i<22;i++) r |= r0[i];
  unsigned a = _mm256_movemask_epi8( _mm256_cmpeq_epi8(r,_mm256_setzero_si256()) ); // 0->0xffffffff
  unsigned long long aa = a;
  aa += 1;
  aa >>= 32;
  return (aa&1);
}


///////////////////////////////




/* byte 0 of output is 1 if input is 0 on GF(3)[x]/x^p-x-1; else 0 */
int crypto_core(unsigned char *outbytes,const unsigned char *inbytes,const unsigned char *kbytes,const unsigned char *cbytes)
{
  ALIGNED unsigned char mm[768];
  memcpy( mm , inbytes , p );
  for(int i=p;i<768;i++) mm[i] = 0;

  for(int i=0;i<768;i+=32) {
    __m256i tmp = _mm256_load_si256((const __m256i*) &mm[i] );
    _mm256_store_si256( (__m256i*)&mm[i] , cvt_to_unsigned(tmp) );
  }

  outbytes[0] = is_multiple_of_fac0(mm)|is_multiple_of_fac1(mm)|is_multiple_of_fac2(mm);

  return 0;
}
