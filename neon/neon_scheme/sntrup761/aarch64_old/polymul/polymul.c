
#include <stdint.h>
#include <stddef.h>
#include <stdio.h>
#include <stdlib.h>
#include <assert.h>

#include <arm_neon.h>

#include "NTT_params.h"

#include "polymul.h"
#include "poly_basic.h"
#include "poly_vec.h"
#include "rader.h"

int16_t pi_table[256] = {
0, 1, 102, 103, 68, 69, 170, 171, 136, 137, 34, 35, 36, 37, 138, 139, 104, 105, 2, 3, 172, 173, 70, 71, 72, 73, 174, 175, 140, 141, 38, 39, 4, 5, 106, 107, 108, 109, 6, 7, 176, 177, 74, 75, 40, 41, 142, 143, 144, 145, 42, 43, 8, 9, 110, 111, 76, 77, 178, 179, 180, 181, 78, 79, 44, 45, 146, 147, 112, 113, 10, 11, 12, 13, 114, 115, 80, 81, 182, 183, 148, 149, 46, 47, 48, 49, 150, 151, 116, 117, 14, 15, 184, 185, 82, 83, 84, 85, 186, 187, 152, 153, 50, 51, 16, 17, 118, 119, 120, 121, 18, 19, 188, 189, 86, 87, 52, 53, 154, 155, 156, 157, 54, 55, 20, 21, 122, 123, 88, 89, 190, 191, 192, 193, 90, 91, 56, 57, 158, 159, 124, 125, 22, 23, 24, 25, 126, 127, 92, 93, 194, 195, 160, 161, 58, 59, 60, 61, 162, 163, 128, 129, 26, 27, 196, 197, 94, 95, 96, 97, 198, 199, 164, 165, 62, 63, 28, 29, 130, 131, 132, 133, 30, 31, 200, 201, 98, 99, 64, 65, 166, 167, 168, 169, 66, 67, 32, 33, 134, 135, 100, 101, 202, 203
};

int16_t std_table[17] = {
0, 12, 24, 36, 48, 60, 72, 84, 96, 108, 120, 132, 144, 156, 168, 180, 192
};

int16_t in_table[12][17] = {
{0, 36, 72, 108, 144, 180, 12, 48, 84, 120, 156, 192, 24, 60, 96, 132, 168},
{1, 37, 73, 109, 145, 181, 13, 49, 85, 121, 157, 193, 25, 61, 97, 133, 169},
{102, 138, 174, 6, 42, 78, 114, 150, 186, 18, 54, 90, 126, 162, 198, 30, 66},
{103, 139, 175, 7, 43, 79, 115, 151, 187, 19, 55, 91, 127, 163, 199, 31, 67},
{68, 104, 140, 176, 8, 44, 80, 116, 152, 188, 20, 56, 92, 128, 164, 200, 32},
{69, 105, 141, 177, 9, 45, 81, 117, 153, 189, 21, 57, 93, 129, 165, 201, 33},
{170, 2, 38, 74, 110, 146, 182, 14, 50, 86, 122, 158, 194, 26, 62, 98, 134},
{171, 3, 39, 75, 111, 147, 183, 15, 51, 87, 123, 159, 195, 27, 63, 99, 135},
{136, 172, 4, 40, 76, 112, 148, 184, 16, 52, 88, 124, 160, 196, 28, 64, 100},
{137, 173, 5, 41, 77, 113, 149, 185, 17, 53, 89, 125, 161, 197, 29, 65, 101},
{34, 70, 106, 142, 178, 10, 46, 82, 118, 154, 190, 22, 58, 94, 130, 166, 202},
{35, 71, 107, 143, 179, 11, 47, 83, 119, 155, 191, 23, 59, 95, 131, 167, 203}
};

int16_t __attribute__((aligned (16)))radix3_args[8] = {Q, Qprime, OMEGA3lo, OMEGA3hi, Qbar};
int16_t __attribute__((aligned (16)))iradix3_args[8] = {Q, Qprime, OMEGA3SQlo, OMEGA3SQhi, Qbar};

int16_t __attribute__((aligned (16)))basemul_table[128] = {
1, -1, -311, 311, 310, -310, 1152, -1152, -174, 174, -978, 978, 305, -305, 1556, -1556, -1861, 1861, -2147, 2147, 2022, -2022, 125, -125, 1205, -1205, 1707, -1707, 1679, -1679, 1678, -1678, 1516, -1516, 1397, -1397, 245, -245, 1852, -1852, -2097, 2097, 2189, -2189, -1311, 1311, -878, 878, 1269, -1269, 167, -167, -1436, 1436, 1950, -1950, -438, 438, -1512, 1512, 1401, -1401, 434, -434, -1835, 1835, -2080, 2080, -451, 451, -2060, 2060, 342, -342, -769, 769, 427, -427, -842, 842, 175, -175, 667, -667, -1283, 1283, -404, 404, 1687, -1687, 286, -286, -1717, 1717, 1431, -1431, -1080, 1080, 737, -737, 343, -343
};

int16_t __attribute__((aligned (16)))basemul_transpose_table[128] = {
1, 1152, 305, -2147, 1205, 1678, 245, 2189, -1, -1152, -305, 2147, -1205, -1678, -245, -2189, -311, -174, 1556, 2022, 1707, 1516, 1852, -1311, 311, 174, -1556, -2022, -1707, -1516, -1852, 1311, 310, -978, -1861, 125, 1679, 1397, -2097, -878, -310, 978, 1861, -125, -1679, -1397, 2097, 878, 1269, 1950, 1401, -2080, 342, -842, -1283, 286, -1269, -1950, -1401, 2080, -342, 842, 1283, -286, 167, -438, 434, -451, -769, 175, -404, -1717, -167, 438, -434, 451, 769, -175, 404, 1717, -1436, -1512, -1835, -2060, 427, 667, 1687, 1431, 1436, 1512, 1835, 2060, -427, -667, -1687, -1431
};

int16_t __attribute__((aligned (16)))CT_table[64] = {
-1, -1950, -1152, -1401, -305, -2080, -2147, -342, -310, -1512, -978, -1835, -1861, -2060, -125, -427, -311, -438, -174, -434, -1556, -451, -2022, -769, -1205, -842, -1678, -1283, -245, -286, -2189, -1080, -1679, -667, -1397, -1687, -2097, -1431, -878, -343, -1707, -175, -1516, -404, -1852, -1717, -1311, -737
};

int16_t __attribute__((aligned (16)))CT_itable[64] = {
-1, -1269, 1080, -2189, -286, 245, -1283, -1678, 311, 167, 737, -1311, -1717, 1852, 404, -1516, 310, -1436, 343, 878, -1431, -2097, -1687, 1397, 842, 1205, -342, -2147, 2080, -305, -1401, 1152, -175, -1707, 769, -2022, -451, -1556, 434, 174, -667, -1679, -427, 125, 2060, -1861, -1835, 978
};

int16_t __attribute__((aligned (16)))Bruun_table0[64] = {
1, 1950, 1152, 1401, 305, -2080, -2147, 342, 310, -1512, -978, -1835, -1861, -2060, 125, 427, -311, -438, -174, 434, 1556, -451, 2022, -769, 1205, -842, 1678, -1283, 245, 286, 2189, -1080, 1679, 667, 1397, 1687, -2097, 1431, -878, 343, 1707, 175, 1516, -404, 1852, -1717, -1311, 737
};

int16_t __attribute__((aligned (16)))Bruun_table1[64] = {
-1229, -1843, -48, -903, -1780, -2094, -204, -1901, -1166, -702, -1155, -782, -1931, -688, -830, -1028, -63, -2046, -1107, -121, -880, -1809, -1034, -1662, -1617, -2013, -867, -45, -1162, -521, -2054, -1339, -2123, -1667, -1232, -222, -1307, -1346, -645, -1352, -851, -346, -2099, -177, -2122, -825, -1409, -1900
};

int16_t __attribute__((aligned (16)))Bruun_itable0[64] = {
1, 1269, -1080, 2189, 286, 245, -1283, 1678, -311, 167, 737, -1311, -1717, 1852, -404, 1516, 310, -1436, 343, -878, 1431, -2097, 1687, 1397, -842, 1205, 342, -2147, -2080, 305, 1401, 1152, 175, 1707, -769, 2022, -451, 1556, 434, -174, 667, 1679, 427, 125, -2060, -1861, -1835, -978
};

int16_t __attribute__((aligned (16)))Bruun_itable1[64] = {
1681, -974, -1626, 1027, -2035, 581, -2273, -1862, 2264, 1066, -950, -1591, -1883, 1061, -2207, 1246, -583, -92, 676, -1973, -673, -1642, 111, 616, 1289, 1487, -1345, 102, 1047, 890, -1844, 24, 173, -1870, 831, 517, -1391, -440, -2235, -1742, -1462, -1234, -514, 415, 344, -1330, 391, 1718
};

int16_t __attribute__((aligned (16)))streamlined_CT_table[128] = {
-1, -1950, -1152, -1401, -305, -2080, -2147, -342, -7, -13918, -8222, -10000, -2177, -14846, -15324, -2441, -310, -1512, -978, -1835, -1861, -2060, -125, -427, -2213, -10792, -6980, -13097, -13283, -14703, -892, -3048, -311, -438, -174, -434, -1556, -451, -2022, -769, -2220, -3126, -1242, -3098, -11106, -3219, -14432, -5489, -1205, -842, -1678, -1283, -245, -286, -2189, -1080, -8601, -6010, -11977, -9157, -1749, -2041, -15624, -7708, -1679, -667, -1397, -1687, -2097, -1431, -878, -343, -11984, -4761, -9971, -12041, -14967, -10214, -6267, -2448, -1707, -175, -1516, -404, -1852, -1717, -1311, -737, -12184, -1249, -10820, -2884, -13219, -12255, -9357, -5260
};

int16_t __attribute__((aligned (16)))streamlined_CT_mul_table[256] = {
-1, -1950, -1152, -1401, -305, -2080, -2147, -342, -7, -13918, -8222, -10000, -2177, -14846, -15324, -2441, 1, 1950, 1152, 1401, 305, 2080, 2147, 342, 7, 13918, 8222, 10000, 2177, 14846, 15324, 2441, -310, -1512, -978, -1835, -1861, -2060, -125, -427, -2213, -10792, -6980, -13097, -13283, -14703, -892, -3048, 310, 1512, 978, 1835, 1861, 2060, 125, 427, 2213, 10792, 6980, 13097, 13283, 14703, 892, 3048, -311, -438, -174, -434, -1556, -451, -2022, -769, -2220, -3126, -1242, -3098, -11106, -3219, -14432, -5489, 311, 438, 174, 434, 1556, 451, 2022, 769, 2220, 3126, 1242, 3098, 11106, 3219, 14432, 5489, -1205, -842, -1678, -1283, -245, -286, -2189, -1080, -8601, -6010, -11977, -9157, -1749, -2041, -15624, -7708, 1205, 842, 1678, 1283, 245, 286, 2189, 1080, 8601, 6010, 11977, 9157, 1749, 2041, 15624, 7708, -1679, -667, -1397, -1687, -2097, -1431, -878, -343, -11984, -4761, -9971, -12041, -14967, -10214, -6267, -2448, 1679, 667, 1397, 1687, 2097, 1431, 878, 343, 11984, 4761, 9971, 12041, 14967, 10214, 6267, 2448, -1707, -175, -1516, -404, -1852, -1717, -1311, -737, -12184, -1249, -10820, -2884, -13219, -12255, -9357, -5260, 1707, 175, 1516, 404, 1852, 1717, 1311, 737, 12184, 1249, 10820, 2884, 13219, 12255, 9357, 5260
};

int16_t __attribute__((aligned (16)))streamlined_GS_table[128] = {
-1, -1269, 1080, -2189, -286, 245, -1283, -1678, -7, -9057, 7708, -15624, -2041, 1749, -9157, -11977, 311, 167, 737, -1311, -1717, 1852, 404, -1516, 2220, 1192, 5260, -9357, -12255, 13219, 2884, -10820, 310, -1436, 343, 878, -1431, -2097, -1687, 1397, 2213, -10249, 2448, 6267, -10214, -14967, -12041, 9971, 842, 1205, -342, -2147, 2080, -305, -1401, 1152, 6010, 8601, -2441, -15324, 14846, -2177, -10000, 8222, -175, -1707, 769, -2022, -451, -1556, 434, 174, -1249, -12184, 5489, -14432, -3219, -11106, 3098, 1242, -667, -1679, -427, 125, 2060, -1861, -1835, 978, -4761, -11984, -3048, 892, 14703, -13283, -13097, 6980
};

int16_t __attribute__((aligned (16)))streamlined_Bruun_table[1024] = {
1, 1950, 1152, 1401, 305, -2080, -2147, 342, 7, 13918, 8222, 10000, 2177, -14846, -15324, 2441, -1229, -1843, -48, -903, -1780, -2094, -204, -1901, -8772, -13154, -343, -6445, -12705, -14946, -1456, -13568, 1, 1269, -1080, 2189, 286, 245, -1283, 1678, 7, 9057, -7708, 15624, 2041, 1749, -9157, 11977, 1681, -974, -1626, 1027, -2035, 581, -2273, -1862, 11998, -6952, -11605, 7330, -14525, 4147, -16223, -13290, 1262, 124, -1523, 527, -734, 1092, -824, 50, 760, 1771, -893, -1018, -1361, 1788, -352, 2031, 1262, 124, -1523, 527, -734, 1092, -824, 50, -760, -1771, 893, 1018, 1361, -1788, 352, -2031, 310, -1512, -978, -1835, -1861, -2060, 125, 427, 2213, -10792, -6980, -13097, -13283, -14703, 892, 3048, -1166, -702, -1155, -782, -1931, -688, -830, -1028, -8322, -5010, -8244, -5581, -13782, -4911, -5924, -7337, -311, 167, 737, -1311, -1717, 1852, -404, 1516, -2220, 1192, 5260, -9357, -12255, 13219, -2884, 10820, 2264, 1066, -950, -1591, -1883, 1061, -2207, 1246, 16159, 7609, -6781, -11356, -13440, 7573, -15752, 8893, 985, 1712, 743, -1906, 2010, -1214, 1656, 1727, 2219, 139, -2263, 181, 899, -557, -712, 1917, 985, 1712, 743, -1906, 2010, -1214, 1656, 1727, -2219, -139, 2263, -181, -899, 557, 712, -1917, -311, -438, -174, 434, 1556, -451, 2022, -769, -2220, -3126, -1242, 3098, 11106, -3219, 14432, -5489, -63, -2046, -1107, -121, -880, -1809, -1034, -1662, -450, -14603, -7901, -864, -6281, -12912, -7380, -11862, 310, -1436, 343, -878, 1431, -2097, 1687, 1397, 2213, -10249, 2448, -6267, 10214, -14967, 12041, 9971, -583, -92, 676, -1973, -673, -1642, 111, 616, -4161, -657, 4825, -14082, -4803, -11720, 792, 4397, -2247, -1836, 780, 1379, -1276, 122, -832, -1777, -1459, -1910, -1370, -1199, 462, -1231, -1064, 643, -2247, -1836, 780, 1379, -1276, 122, -832, -1777, 1459, 1910, 1370, 1199, -462, 1231, 1064, -643, 1205, -842, 1678, -1283, 245, 286, 2189, -1080, 8601, -6010, 11977, -9157, 1749, 2041, 15624, -7708, -1617, -2013, -867, -45, -1162, -521, -2054, -1339, -11541, -14368, -6188, -321, -8294, -3719, -14660, -9557, -842, 1205, 342, -2147, -2080, 305, 1401, 1152, -6010, 8601, 2441, -15324, -14846, 2177, 10000, 8222, 1289, 1487, -1345, 102, 1047, 890, -1844, 24, 9200, 10613, -9600, 728, 7473, 6352, -13161, 171, 1089, -2083, 1185, 1477, 1593, -1757, -1264, 567, -2250, -1583, -1496, -1698, -1915, -989, 1767, -330, 1089, -2083, 1185, 1477, 1593, -1757, -1264, 567, 2250, 1583, 1496, 1698, 1915, 989, -1767, 330, 1679, 667, 1397, 1687, -2097, 1431, -878, 343, 11984, 4761, 9971, 12041, -14967, 10214, -6267, 2448, -2123, -1667, -1232, -222, -1307, -1346, -645, -1352, -15153, -11898, -8793, -1585, -9329, -9607, -4604, -9650, 175, 1707, -769, 2022, -451, 1556, 434, -174, 1249, 12184, -5489, 14432, -3219, 11106, 3098, -1242, 173, -1870, 831, 517, -1391, -440, -2235, -1742, 1235, -13347, 5931, 3690, -9928, -3140, -15952, -12433, -2144, 1601, 70, -1230, -1998, 1659, -1605, 1312, 1918, -1076, 1565, -113, -1265, 18, -1383, 1628, -2144, 1601, 70, -1230, -1998, 1659, -1605, 1312, -1918, 1076, -1565, 113, 1265, -18, 1383, -1628, 1707, 175, 1516, -404, 1852, -1717, -1311, 737, 12184, 1249, 10820, -2884, 13219, -12255, -9357, 5260, -851, -346, -2099, -177, -2122, -825, -1409, -1900, -6074, -2470, -14981, -1263, -15146, -5888, -10057, -13561, 667, 1679, 427, 125, -2060, -1861, -1835, -978, 4761, 11984, 3048, 892, -14703, -13283, -13097, -6980, -1462, -1234, -514, 415, 344, -1330, 391, 1718, -10435, -8808, -3669, 2962, 2455, -9493, 2791, 12262, 1055, 482, -1255, -247, 405, 98, -1722, -1879, 332, -507, 69, 1585, -1411, 1007, -1441, -1298, 1055, 482, -1255, -247, 405, 98, -1722, -1879, -332, 507, -69, -1585, 1411, -1007, 1441, 1298
};

const int16x8_t lastwlo = {-1080, 1080, 737, -737, 343, -343, 0, 0
};
const int16x8_t lastwhi = {-7708, 7708, 5260, -5260, 2448, -2448, 0, 0
};

// whi = ((even (w r cmod q) in [-q, q]) * Qprime cmod r) / 2
static int16_t gethi(int16_t w){

    int16_t t;
    t = mulmod_int16(w, RmodQ);
    if( (t & 1) && (t > 0) ){
        t -= Q;
    }
    if( (t & 1) && (t < 0) ){
        t += Q;
    }
    t = t * Qprime;
    assert( (t & 1) == 0 );
    return t >> 1;

}

static int16x8_t gethix8(int16x8_t w){

    int16x8_t t;
    for(size_t i = 0; i < 8; i++){
        t[i] = gethi(w[i]);
    }

    return t;

}

// in: (c0, c1, c2, c3)
// out: (c0, c1, c2, c3)
#define TRN4(c0, c1, c2, c3, b0, b1, b2, b3) { \
    b0 = (int16x8_t)vtrn1q_s16(c0, c1); \
    b1 = (int16x8_t)vtrn2q_s16(c0, c1); \
    b2 = (int16x8_t)vtrn1q_s16(c2, c3); \
    b3 = (int16x8_t)vtrn2q_s16(c2, c3); \
    c0 = (int16x8_t)vtrn1q_s32((int32x4_t)b0, (int32x4_t)b2); \
    c2 = (int16x8_t)vtrn2q_s32((int32x4_t)b0, (int32x4_t)b2); \
    c1 = (int16x8_t)vtrn1q_s32((int32x4_t)b1, (int32x4_t)b3); \
    c3 = (int16x8_t)vtrn2q_s32((int32x4_t)b1, (int32x4_t)b3); \
}

// in: (b0, b1, b2, b3)
// out: (c0, c1, c2, c3)
#define TRN8(c0, c1, c2, c3, c4, c5, c6, c7, b0, b1, b2, b3, b4, b5, b6, b7) { \
    TRN4(b0, b1, b2, b3, c0, c1, c2, c3); \
    TRN4(b4, b5, b6, b7, c4, c5, c6, c7); \
    c0 = (int16x8_t)vtrn1q_s64((int64x2_t)b0, (int64x2_t)b4); \
    c4 = (int16x8_t)vtrn2q_s64((int64x2_t)b0, (int64x2_t)b4); \
    c1 = (int16x8_t)vtrn1q_s64((int64x2_t)b1, (int64x2_t)b5); \
    c5 = (int16x8_t)vtrn2q_s64((int64x2_t)b1, (int64x2_t)b5); \
    c2 = (int16x8_t)vtrn1q_s64((int64x2_t)b2, (int64x2_t)b6); \
    c6 = (int16x8_t)vtrn2q_s64((int64x2_t)b2, (int64x2_t)b6); \
    c3 = (int16x8_t)vtrn1q_s64((int64x2_t)b3, (int64x2_t)b7); \
    c7 = (int16x8_t)vtrn2q_s64((int64x2_t)b3, (int64x2_t)b7); \
}

#define RADIX3(c0, c1, c2) { \
    t0 = c1 - c2; \
    t3 = vmulq_n_s16(t0, mul_args[2]); \
    t2 = vqrdmulhq_n_s16(t0, mul_args[3]); \
    t3 = vmlsq_n_s16(t3, t2, mul_args[0]); \
    t1 = c0 - c2; \
    t2 = c0 - c1; \
    c0 = c0 + c1 + c2; \
    c1 = t1 + t3; \
    c2 = t2 - t3; \
}

// ================================
// build table for 3D permutation of dimension 17 x 3 x 32
// this is slightly different from the usual one
void setup_pi_table(void){

    size_t t;

    for(size_t i = 0; i < _POLY_N / 8; i++){
        t = i / 2;
        pi_table[(((t % 17) * 6 + (t % 3) * 2 + (t % 2) ) * 2 + (i % 2))] = i;
    }

    for(size_t j = 0; j < 17; j++){
        std_table[j] = 12 * j;
    }
    for(size_t i = 0; i < 12; i++){
        for(size_t j = 0; j < 17; j++){
            in_table[i][j] = pi_table[12 * j + i];
        }
    }

}

// ================================
// set up table for base multiplications
// require twiddle_table[17][17]
void setup_basemul_table(void){

    for(size_t i = 0; i < 17; i++){
        basemul_table[i * 6 + 0] = mulmod_int16(twiddle_table[1][i], 1);
        basemul_table[i * 6 + 1] = -basemul_table[i * 6 + 0];
        basemul_table[i * 6 + 2] = mulmod_int16(twiddle_table[1][i], OMEGA3);
        basemul_table[i * 6 + 3] = -basemul_table[i * 6 + 2];
        basemul_table[i * 6 + 4] = mulmod_int16(twiddle_table[1][i], OMEGA3SQ);
        basemul_table[i * 6 + 5] = -basemul_table[i * 6 + 4];
    }

    for(size_t i = 0; i < 16 * 6; i += 8 * 6){
        for(size_t j = 0; j < 6; j++){
            for(size_t k = 0; k < 8; k++){
                basemul_transpose_table[i + j * 8 + k] = basemul_table[i + j + k * 6];
            }
        }
    }

}

// ================================
// consturct tables of twiddle for Cooley--Tukey and Bruun's
// Cooley--Tukey:
// (x^4 - c) = (x^2 - sqrt(c)) (x^2 + sqrt(c))
// Bruun's:
// (x^4 + c) = (x^2 + sqrt(2 sqrt(c)) x + sqrt(c)) (x^2 - sqrt(2 sqrt(c)) x + sqrt(c))
// or        = (x^2 + sqrt(- 2 sqrt(c)) x - sqrt(c)) (x^2 - sqrt(- 2 sqrt(c)) x - sqrt(c))
// require sqrt_table, inv_table, basemul_transpose_table
void setup_CT_Bruun_table(void){

    int16_t t;

    for(size_t i = 0; i < 6; i++){
        for(size_t j = 0; j < 8; j++){
            CT_table[i * 8 + j] = cmod_int16(sqrt_table[(Q + basemul_transpose_table[i * 16 + j]) % Q]);
        }
        for(size_t j = 0; j < 8; j++){
            t = sqrt_table[(Q + basemul_transpose_table[i * 16 + j]) % Q];
            if(sqrt_table[t] == -1){
                t = Q - t;
            }
            Bruun_table0[i * 8 + j] = cmod_int16(t);
            Bruun_table1[i * 8 + j] = cmod_int16(sqrt_table[(2 * t) % Q]);
        }
    }

    for(size_t i = 0; i < 6 * 8; i++){
        Bruun_itable0[i] = cmod_int16(inv_table[(Bruun_table0[i] + Q) % Q]);
        Bruun_itable1[i] = cmod_int16(inv_table[(Bruun_table1[i] + Q) % Q]);
    }

    for(size_t i = 0; i < 48; i++){
        CT_itable[i] = cmod_int16(inv_table[(Q + CT_table[i]) % Q]);
    }

}

// ================================
// construct streamlined Cooley--Tukey tables
void setup_streamlined_CT_table(void){

    int16x8_t w0, w1, w2, w3;

    for(size_t i = 0; i < 6; i++){
        w0 = vld1q_s16(CT_table + i * 8);
        w1 = gethix8(w0);
        vst1q_s16(streamlined_CT_table + (2 * i + 0) * 8, w0);
        vst1q_s16(streamlined_CT_table + (2 * i + 1) * 8, w1);
    }

    for(size_t i = 0; i < 6; i++){
        w0 = vld1q_s16(CT_table + i * 8);
        w1 = gethix8(w0);
        w2 = -w0;
        w3 = gethix8(w2);
        vst1q_s16(streamlined_CT_mul_table + (4 * i + 0) * 8, w0);
        vst1q_s16(streamlined_CT_mul_table + (4 * i + 1) * 8, w1);
        vst1q_s16(streamlined_CT_mul_table + (4 * i + 2) * 8, w2);
        vst1q_s16(streamlined_CT_mul_table + (4 * i + 3) * 8, w3);
    }

    for(size_t i = 0; i < 6; i++){
        w0 = vld1q_s16(CT_itable + i * 8);
        w1 = gethix8(w0);
        vst1q_s16(streamlined_GS_table + (2 * i + 0) * 8, w0);
        vst1q_s16(streamlined_GS_table + (2 * i + 1) * 8, w1);
    }

}

// ================================
// construct streamlined Bruun tables
// require Bruun_table0, Bruun_table1, Bruun_itable0, Bruun_itable1
void setup_streamlined_Bruun_table(void){

    int16x8_t w0, w1, w2, w3, w4, w5, w6, w7;

    for(size_t i = 0; i < 2; i++){
        for(size_t j = 0; j < 3; j++){

            w0 = vld1q_s16(Bruun_table0 + ( i * 3 + j ) * 8);
            w1 = gethix8(w0);
            w2 = vld1q_s16(Bruun_table1 + ( i * 3 + j ) * 8);
            w3 = gethix8(w2);
            w4 = vld1q_s16(Bruun_itable0 + ( i * 3 + j ) * 8);
            w5 = gethix8(w4);
            w6 = vld1q_s16(Bruun_itable1 + ( i * 3 + j ) * 8);
            w7 = gethix8(w6);

            vst1q_s16(streamlined_Bruun_table + (i * 3 + j) * 96 + 0 * 8 , w0);
            vst1q_s16(streamlined_Bruun_table + (i * 3 + j) * 96 + 1 * 8 , w1);
            vst1q_s16(streamlined_Bruun_table + (i * 3 + j) * 96 + 2 * 8 , w2);
            vst1q_s16(streamlined_Bruun_table + (i * 3 + j) * 96 + 3 * 8 , w3);
            vst1q_s16(streamlined_Bruun_table + (i * 3 + j) * 96 + 4 * 8 , w4);
            vst1q_s16(streamlined_Bruun_table + (i * 3 + j) * 96 + 5 * 8 , w5);
            vst1q_s16(streamlined_Bruun_table + (i * 3 + j) * 96 + 6 * 8 , w6);
            vst1q_s16(streamlined_Bruun_table + (i * 3 + j) * 96 + 7 * 8 , w7);

            w0 = mulmod_int16x8(vld1q_s16(Bruun_table0 + ( i * 3 + j ) * 8), vdupq_n_s16(RmodQ));
            w1 = mulmod_int16x8(vld1q_s16(Bruun_table1 + ( i * 3 + j ) * 8), vdupq_n_s16(RmodQ));
            w3 = -w1;

            vst1q_s16(streamlined_Bruun_table + (i * 3 + j) * 96 + 8 * 8 , w0);
            vst1q_s16(streamlined_Bruun_table + (i * 3 + j) * 96 + 9 * 8 , w1);
            vst1q_s16(streamlined_Bruun_table + (i * 3 + j) * 96 + 10 * 8 , w0);
            vst1q_s16(streamlined_Bruun_table + (i * 3 + j) * 96 + 11 * 8 , w3);

        }
    }

}

void polymul(int16_t *des, int16_t *src1, int16_t *src2){


    int16_t poly1_NTT[51 * 32], poly2_NTT[51 * 32];
    int16x8_t poly1_CT[24 * 4], poly2_CT[24 * 4];
    int16x8_t poly1_Bruun[24 * 4], poly2_Bruun[24 * 4];
    int16x8_t buff0[32];
    int16x8_t buff1[32];
    int16x8_t buff2[32];
    // int16_t t_res[_POLY_N];
    int16_t *res_NTT = poly1_NTT;
    int16x8_t *res_CT = poly1_CT;
    int16x8_t *res_Bruun = poly1_Bruun;
    int16x8_t *poly1_CT_ptr;
    int16x8_t *poly2_CT_ptr;
    int16x8_t *res_CT_ptr;
    int16x8_t *poly1_Bruun_ptr;
    int16x8_t *poly2_Bruun_ptr;
    int16x8_t *res_Bruun_ptr;
    int16x8_t *twiddle_ptr;

    // Rader-17

    for(size_t i = 0; i < 12; i++){
        __asm_rader_17_mix_pre((int16x8_t*)(poly1_NTT + (i) * 8), (int16x8_t*)src1, in_table[i], twiddle_permutedx8);
    }

    for(size_t i = 0; i < 12; i++){
        __asm_rader_17_mix_pre((int16x8_t*)(poly2_NTT + (i) * 8), (int16x8_t*)src2, in_table[i], twiddle_permutedx8);
    }

    __asm_radix32(poly1_NTT, radix3_args);
    __asm_radix32(poly2_NTT, radix3_args);

    // x^16 - c
    // = ( x^8 - sqrt(c) ) ( x^8 + sqrt(c) )
    __asm_transpose_CT(poly1_CT, poly1_NTT, (int16x8_t*)streamlined_CT_table, Q);
    __asm_transpose_CT(poly2_CT, poly2_NTT, (int16x8_t*)streamlined_CT_table, Q);

    poly1_CT_ptr = poly1_CT;
    poly2_CT_ptr = poly2_CT;
    res_CT_ptr = poly1_CT_ptr;
    twiddle_ptr = (int16x8_t*)streamlined_CT_mul_table;
    for(size_t i = 0; i < 2; i++){
        for(size_t j = 0; j < 3; j++){

            // 0, 1
            __asm_weighted8x8(res_CT_ptr + 0 * 8, poly1_CT_ptr + 0 * 8, poly2_CT_ptr + 0 * 8, twiddle_ptr + 0);
            // 2, 3
            __asm_weighted8x8(res_CT_ptr + 1 * 8, poly1_CT_ptr + 1 * 8, poly2_CT_ptr + 1 * 8, twiddle_ptr + 2);

            poly1_CT_ptr += 16;
            poly2_CT_ptr += 16;
            res_CT_ptr += 16;
            twiddle_ptr += 4;

        }
    }

    __asm_transpose_GS(res_NTT, res_CT, (int16x8_t*)streamlined_GS_table, Q);


    // x^16 + c
    // = ( x^8 + sqrt(c) )^2 - 2 sqrt(c) x^8
    // = ( x^8 + sqrt(2 sqrt(c) ) x^4 + sqrt(c) )
    //   ( x^8 - sqrt(2 sqrt(c) ) x^4 + sqrt(c) )
    // for well-defined sqrt( 2 sqrt(c) )
    __asm_transpose_Bruun(poly1_Bruun, poly1_NTT + 16, (int16x8_t*)streamlined_Bruun_table, Q);
    __asm_transpose_Bruun(poly2_Bruun, poly2_NTT + 16, (int16x8_t*)streamlined_Bruun_table, Q);

    poly1_Bruun_ptr = poly1_Bruun;
    poly2_Bruun_ptr = poly2_Bruun;
    res_Bruun_ptr = poly1_Bruun_ptr;
    twiddle_ptr = (int16x8_t*)streamlined_Bruun_table;
    for(size_t i = 0; i < 2; i++){
        for(size_t j = 0; j < 3; j++){

            // 0, 1
            __asm_Bruun_GF_mul(res_Bruun_ptr + 0 * 8, poly1_Bruun_ptr + 0 * 8, poly2_Bruun_ptr + 0 * 8, twiddle_ptr + 8);

            // 0, 1
            __asm_Bruun_GF_mul(res_Bruun_ptr + 1 * 8, poly1_Bruun_ptr + 1 * 8, poly2_Bruun_ptr + 1 * 8, twiddle_ptr + 10);

            poly1_Bruun_ptr += 16;
            poly2_Bruun_ptr += 16;
            res_Bruun_ptr += 16;
            twiddle_ptr += 12;

        }
    }

    __asm_transpose_iBruun(res_NTT + 16, res_Bruun, (int16x8_t*)streamlined_Bruun_table, Q);



// compute the 16-th row
// ================================


    for(size_t i = 96; i < 102; i++){
        for(size_t j = 0; j < 16; j++){
            buff0[j][i - 96] = poly1_NTT[i * 16 + j];
            buff1[j][i - 96] = poly2_NTT[i * 16 + j];
        }
    }

    weighted_Rmod_16x16_x8(buff2, buff0, buff1, lastwlo, lastwhi);

    for(size_t i = 96; i < 102; i++){
        for(size_t j = 0; j < 16; j++){
            res_NTT[i * 16 + j] = buff2[j][i - 96];
       }
    }

// ================================

    __asm_radix32(res_NTT, iradix3_args);

    // Rader-17
    for(size_t i = 0; i < 12; i++){

        __asm_rader_17_mix_post((int16x8_t*)(des), (int16x8_t*)(res_NTT + i * 8), in_table[i], twiddle_inv_permutedx8);

    }

}

